# 🎲 多卡池抽卡系统 (Multi-Pool Gacha System)

一个功能完整的本地抽卡游戏系统，支持多卡池管理、管理员权限、自定义价格、用户抽卡体验等全方位功能。

## ✨ 核心特性

### 🎯 多卡池系统
- ✅ **多卡池支持**: 系统支持创建无限个卡池，每个卡池独立配置
- ✅ **卡池管理**: 管理员可创建、编辑、删除、激活/停用卡池
- ✅ **自定义价格**: 每个卡池可设置独立的单抽/十连价格
- ✅ **物品权重管理**: 每个卡池中的物品权重可独立配置
- ✅ **动态概率**: 概率页面根据选择的卡池实时更新显示
- ✅ **卡池描述**: 支持为每个卡池添加描述信息

### 🎲 抽卡核心功能
- ✅ **单次抽卡**: 花费对应卡池价格获得1个随机物品
- ✅ **十连抽卡**: 花费对应卡池价格获得10个物品
- ✅ **保底机制**: 十连抽第10个保底稀有物品（蓝色以上）
- ✅ **权重算法**: 基于物品权重的加权随机抽取
- ✅ **稀有度系统**: 神话(红)、传说(金)、史诗(紫)、稀有(蓝)、普通(灰)
- ✅ **抽卡记录**: 完整记录包含卡池信息的历史数据

### 🛠️ 管理员系统
- ✅ **权限验证**: 基于用户ID的管理员权限校验
- ✅ **卡池管理**: 创建、编辑、删除、激活/停用卡池
- ✅ **价格设置**: 为每个卡池设置独立的单抽/十连价格
- ✅ **物品管理**: 向卡池添加/移除物品，调整权重
- ✅ **智能权重**: 添加物品时自动填充默认权重值
- ✅ **概率查看**: 实时查看各卡池的概率分布
- ✅ **统计报告**: 查看系统运行统计数据
- ✅ **管理员界面**: 专用的web管理界面(admin.html)

### 🎨 用户体验
- ✅ **卡池选择器**: 前端可动态选择和切换卡池
- ✅ **实时价格显示**: 选择卡池后自动显示对应价格
- ✅ **智能按钮**: 根据货币余额和卡池价格自动启用/禁用抽卡按钮
- ✅ **概率联动**: 概率页面根据选择的卡池实时更新
- ✅ **响应式设计**: 支持桌面和移动设备
- ✅ **现代UI**: 渐变背景、毛玻璃效果、发光动画

### 💰 经济系统
- ✅ **灵活定价**: 每个卡池可设置不同的抽卡价格
- ✅ **动态扣费**: 根据选择的卡池自动使用对应价格扣费
- ✅ **虚拟充值**: 6种充值套餐，包含赠送奖励
- ✅ **余额管理**: 实时货币余额显示和消费记录

### 🔧 技术实现
- ✅ **前后端分离**: Flask后端API + 静态前端页面
- ✅ **RESTful API**: 完整的卡池管理和抽卡API接口
- ✅ **会话管理**: 管理员登录会话和权限验证
- ✅ **编码修复**: 解决卡池名称中文乱码问题
- ✅ **完整测试**: 多个自动化测试脚本验证功能

## 📁 项目结构

```
banana3/
├── 🎯 后端核心
│   ├── app.py                    # Flask API服务器 (支持多卡池、管理员权限)
│   └── requirements.txt          # Python依赖包
│
├── 🌐 前端界面
│   ├── gacha.html               # 主抽卡界面 (支持卡池选择、动态价格)
│   ├── admin.html               # 管理员专用界面 (卡池管理、权重设置)
│   ├── register.html            # 用户注册页面
│   ├── frontend.html            # 首页导航
│   ├── frontend.js              # 前端通用脚本
│   └── frontend_server.py       # 静态文件服务器 (集成管理员登录)
│
├── 🧪 测试脚本
│   ├── test_pool_management.py   # 卡池管理功能测试
│   ├── test_custom_prices.py     # 自定义价格功能测试
│   ├── test_updates.py          # 功能更新测试 (编码、权限等)
│   ├── test_gacha_api.py        # 抽卡API测试
│   ├── test_currency_system.py  # 货币系统测试
│   ├── test_full_system.py      # 完整系统测试
│   └── 其他测试文件...
│
├── 🚀 启动脚本
│   └── start_server.py          # 一键启动脚本
│
└── 📖 项目文档
    └── README.md                # 完整项目说明 (本文件)
```

## 🚀 快速开始

### 方式一：一键启动 (推荐)

```bash
# 克隆项目
git clone <项目地址>
cd banana3

# 安装依赖
pip install -r requirements.txt

# 一键启动 (自动启动后端和前端)
python start_server.py
```

### 方式二：分别启动

```bash
# 1. 启动后端服务器 (Flask API)
python app.py
# 后端运行在: http://127.0.0.1:5000/

# 2. 启动前端服务器 (另开一个终端)
python frontend_server.py
# 前端运行在: http://127.0.0.1:3000/
```

### 方式三：使用VS Code任务

```bash
# 在VS Code中执行任务
Ctrl+Shift+P → "Tasks: Run Task" → "启动Python后端服务器"
```

## 🌐 访问地址

启动完成后可访问以下页面：

- **🏠 首页导航**: http://127.0.0.1:3000/
- **🎲 抽卡系统**: http://127.0.0.1:3000/gacha
- **🛠️ 管理员界面**: http://127.0.0.1:3000/admin (需要登录)
- **📝 用户注册**: http://127.0.0.1:3000/register
- **🔧 后端API**: http://127.0.0.1:5000/api/

## 👤 默认账号

**用户账号 (具有管理员权限):**
- 🔑 账号: `fhc`
- 🔐 密码: `114514`
- 💰 初始货币: 10000

**首次使用建议:**
1. 使用默认账号登录系统
2. 访问管理员界面创建新卡池
3. 向卡池添加物品并设置权重
4. 体验多卡池抽卡功能

## 🧪 测试系统

完整的自动化测试脚本验证系统功能：

```bash
# 测试多卡池管理功能
python test_pool_management.py

# 测试自定义价格功能
python test_custom_prices.py

# 测试功能更新 (编码、权限等)
python test_updates.py

# 测试抽卡API
python test_gacha_api.py

# 测试货币系统
python test_currency_system.py

# 测试完整系统
python test_full_system.py
```

## 🎮 详细使用说明

### 🎯 多卡池使用

**用户操作流程:**
1. 打开抽卡系统页面 (gacha.html)
2. 在卡池选择器中选择想要的卡池
3. 系统自动显示该卡池的单抽/十连价格
4. 确认货币充足后点击抽卡按钮
5. 查看抽卡结果和概率信息

**卡池类型示例:**
- **标准卡池**: 160/1600货币，包含所有基础物品
- **限定卡池**: 自定义价格，通常价格更高但稀有物品概率提升
- **活动卡池**: 临时卡池，包含特殊物品

### 🛠️ 管理员功能

**卡池管理操作:**
1. 访问管理员界面 (需要admin权限)
2. 在"卡池管理"页面创建新卡池
3. 设置卡池名称、描述、单抽/十连价格
4. 在"物品管理"页面向卡池添加物品
5. 调整每个物品在该卡池中的权重
6. 启用卡池供用户使用

**权重调整说明:**
- 权重越高，抽中概率越大
- 添加物品时系统自动填充默认权重
- 可以根据稀有度调整合理的权重值
- 实时查看权重调整后的概率分布

### 💰 经济系统

**充值套餐:**
- 💰 新手礼包: 100币 (¥1)
- 💰 小额充值: 500币+50赠送 (¥5)
- 💰 标准充值: 1000币+100赠送 (¥10)
- 💰 豪华充值: 2000币+300赠送 (¥20) **推荐**
- 💰 至尊充值: 5000币+1000赠送 (¥50)
- 💰 王者充值: 10000币+2500赠送 (¥100)

**价格机制:**
- 每个卡池可以设置独立的单抽/十连价格
- 系统自动根据选择的卡池扣除对应费用
- 货币不足时自动禁用抽卡按钮

## 📡 API 文档

### 🎯 卡池管理 API

#### 获取所有卡池
```http
GET /api/pools
```

#### 获取卡池详情
```http
GET /api/pools/{pool_id}
```

#### 创建卡池 (管理员)
```http
POST /api/pools
Content-Type: application/json

{
  "name": "限定卡池",
  "description": "高稀有度限定卡池",
  "admin_id": 1,
  "single_cost": 250,
  "ten_cost": 2200,
  "is_active": true
}
```

#### 更新卡池 (管理员)
```http
PUT /api/pools/{pool_id}
Content-Type: application/json

{
  "name": "更新后的卡池名称",
  "description": "更新后的描述",
  "admin_id": 1,
  "single_cost": 200,
  "ten_cost": 1800
}
```

#### 删除卡池 (管理员)
```http
DELETE /api/pools/{pool_id}
Content-Type: application/json

{
  "admin_id": 1
}
```

### 🔧 卡池物品管理 API

#### 向卡池添加物品 (管理员)
```http
POST /api/pools/{pool_id}/items
Content-Type: application/json

{
  "item_id": 5,
  "weight": 10.0,
  "admin_id": 1
}
```

#### 更新物品权重 (管理员)
```http
PUT /api/pools/{pool_id}/items/{item_id}
Content-Type: application/json

{
  "weight": 15.0,
  "admin_id": 1
}
```

#### 从卡池移除物品 (管理员)
```http
DELETE /api/pools/{pool_id}/items/{item_id}
Content-Type: application/json

{
  "admin_id": 1
}
```

#### 获取卡池概率分布
```http
GET /api/pools/{pool_id}/rates
```

### 🎲 抽卡 API

#### 单次抽卡
```http
POST /api/draw/single
Content-Type: application/json

{
  "user_id": 1,
  "pool_id": 2
}
```

#### 十连抽卡
```http
POST /api/draw/ten
Content-Type: application/json

{
  "user_id": 1,
  "pool_id": 1
}
```

#### 获取抽卡历史
```http
GET /api/draw/history/{user_id}
```

### 👤 用户管理 API

#### 用户登录
```http
POST /api/auth/login
Content-Type: application/json

{
  "account": "fhc",
  "password": "114514"
}
```

#### 用户注册
```http
POST /api/auth/register
Content-Type: application/json

{
  "account": "newuser",
  "password": "password123",
  "name": "新用户"
}
```

#### 获取用户信息
```http
GET /api/users/{user_id}
```

#### 获取用户背包
```http
GET /api/inventory/{user_id}
```

### 💰 充值 API

#### 虚拟充值
```http
POST /api/recharge
Content-Type: application/json

{
  "user_id": 1,
  "amount": 1000
}
```

#### 获取充值套餐
```http
GET /api/recharge/packages
```

### 📊 统计 API

#### 系统统计概览
```http
GET /api/stats/overview
```

#### 用户统计数据
```http
GET /api/stats/user/{user_id}
```

## 🎨 数据结构

### 卡池数据结构
```json
{
  "id": 1,
  "name": "标准卡池",
  "description": "包含所有基础物品的标准卡池",
  "is_active": true,
  "single_cost": 160,
  "ten_cost": 1600,
  "created_by": 1,
  "created_at": "2025-01-20T10:30:00.000000"
}
```

### 物品数据结构
```json
{
  "id": 1,
  "name": "雾切之回光",
  "description": "神里流·霜灭",
  "rarity": "传说",
  "type": "武器"
}
```

### 卡池物品关系
```json
{
  "pool_id": 1,
  "item_id": 1,
  "weight": 2.0
}
```

### 抽卡记录
```json
{
  "id": 1,
  "user_id": 1,
  "item": {
    "id": 1,
    "name": "雾切之回光",
    "rarity": "传说"
  },
  "pool_name": "标准卡池",
  "draw_type": "single",
  "cost": 160,
  "timestamp": "2025-01-20T15:19:12.676976"
}
```

## 🛠️ 技术栈

### 后端技术
- **Python 3.7+**: 主要编程语言
- **Flask**: 轻量级Web框架
- **Flask-CORS**: 处理跨域请求
- **内存数据存储**: 用于演示 (可扩展为数据库)

### 前端技术
- **HTML5**: 页面结构
- **CSS3**: 样式设计 (渐变、动画、毛玻璃效果)
- **JavaScript**: 交互逻辑和API调用
- **Font Awesome**: 图标库
- **响应式设计**: 适配各种设备

### 开发工具
- **VS Code**: 推荐IDE
- **VS Code Tasks**: 集成的任务运行
- **自动化测试**: 完整的测试脚本覆盖

## 🔧 系统特色

### 🎯 核心亮点
1. **多卡池独立配置**: 每个卡池完全独立，价格、物品、权重都可单独设置
2. **管理员权限系统**: 严格的权限验证，只有管理员可以管理卡池
3. **实时价格显示**: 前端选择卡池后立即显示对应价格
4. **智能权重填充**: 管理员添加物品时自动填充合理的默认权重
5. **概率实时联动**: 概率页面随卡池选择实时更新
6. **中文编码支持**: 完全解决中文卡池名称乱码问题

### 🎨 用户体验
1. **现代化UI设计**: 渐变背景、毛玻璃效果、稀有物品发光动画
2. **响应式布局**: 完美适配桌面和移动设备
3. **智能交互**: 货币不足时自动禁用按钮，避免无效操作
4. **详细反馈**: 每次操作都有明确的成功/失败反馈

### 🔧 开发友好
1. **RESTful API**: 标准的API设计，易于扩展和集成
2. **完整测试**: 多个自动化测试脚本验证所有功能
3. **清晰架构**: 前后端分离，代码结构清晰
4. **详细文档**: 完整的API文档和使用说明

## 🚀 扩展建议

### 📊 数据存储升级
- 集成 SQLite/MySQL/PostgreSQL 数据库
- 实现数据持久化和备份机制
- 支持大量用户和数据的高性能查询

### 🔐 安全性增强
- JWT Token 身份验证
- API 访问频率限制
- 数据加密和安全传输

### 🎮 游戏功能扩展
- 用户等级和经验系统
- 成就和徽章系统
- 每日任务和活动系统
- 好友系统和社交功能

### 📱 多平台支持
- 开发原生移动应用 (React Native/Flutter)
- 微信小程序版本
- 桌面应用 (Electron)

### 🌐 部署和运维
- Docker 容器化部署
- Kubernetes 集群管理
- 监控和日志系统
- 自动化CI/CD流程

## 🐛 常见问题解决

### 启动问题
**端口被占用:**
```bash
# 查看端口占用
netstat -ano | findstr :5000
# 或者修改端口
# 在 app.py 中修改 port 参数
```

**依赖安装失败:**
```bash
# 确保 Python 版本正确
python --version  # 需要 >= 3.7

# 升级 pip
python -m pip install --upgrade pip

# 手动安装依赖
pip install Flask Flask-CORS
```

### 功能问题
**管理员权限不足:**
- 确保使用正确的管理员账号 (fhc/114514)
- 检查 user_id 是否为数字类型
- 查看浏览器控制台的错误信息

**卡池选择器不显示:**
- 确保后端服务器正常运行
- 检查 API 请求是否成功
- 验证卡池数据是否正确创建

**概率页面不更新:**
- 确保选择了有效的卡池
- 检查卡池是否包含物品
- 验证物品权重是否正确设置

### 性能问题
**响应速度慢:**
- 检查网络连接
- 考虑使用数据库优化数据存储
- 实现数据缓存机制

## 📝 更新日志

### v2.0.0 (当前版本) - 多卡池系统
- ✅ 实现多卡池支持
- ✅ 添加卡池管理员功能
- ✅ 支持自定义抽卡价格
- ✅ 修复中文编码问题
- ✅ 完善管理员权限验证
- ✅ 优化前端用户体验
- ✅ 添加完整的测试覆盖

### v1.0.0 - 基础抽卡系统
- ✅ 基本抽卡功能
- ✅ 用户注册登录
- ✅ 货币和充值系统
- ✅ 基础UI界面

## 🤝 贡献指南

欢迎为项目贡献代码或提出建议！

### 如何贡献
1. Fork 项目仓库
2. 创建功能分支 (`git checkout -b feature/新功能`)
3. 提交更改 (`git commit -m '添加新功能'`)
4. 推送到分支 (`git push origin feature/新功能`)
5. 创建 Pull Request

### 代码规范
- 使用有意义的变量和函数名
- 添加适当的注释
- 遵循 PEP 8 Python 代码规范
- 确保所有测试通过

## 📄 许可证

本项目采用 MIT 许可证 - 详见 [LICENSE](LICENSE) 文件

## 👨‍💻 作者信息

- **项目维护者**: [作者名称]
- **项目仓库**: [项目仓库地址]
- **技术支持**: [联系方式]

---

**🎊 享受多卡池抽卡的乐趣吧！** 🎊

> 这是一个功能完整的多卡池抽卡系统，支持管理员管理、自定义价格、实时概率显示等高级功能。系统设计灵活，易于扩展，是学习Web开发和游戏系统设计的理想项目。
